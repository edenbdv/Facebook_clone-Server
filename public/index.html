<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User</title>
</head>

<body>
    <form id="userForm">
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username" required>
        <button onclick="update('username')">Update</button><br>


        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password" required>
        <button onclick="update('password')">Update</button><br>


        <label for="displayName">Display Name:</label><br>
        <input type="text" id="displayName" name="displayName" required>
        <button onclick="update('displayName')">Update</button><br>


        <label for="profilePic">Profile Picture:</label><br>
        <input type="text" id="profilePic" name="profilePic" required>
        <button onclick="update('profilePic')">Update</button><br>


        <button type="button" onclick="create()">Add User</button><br><br>
        <input id="userIdInput" placeholder="Receiver's ID"><button onclick="get()">Get one</button>
        <button onclick="del()">Delete</button><br>

        <!-- Button to get user friends -->
        <button onclick="getUserFriends()">Get User Friends</button>
        <button onclick="addFriendRequest()">Add Friend Request</button>
        <button onclick="acceptReq()">accept Friend Request</button>



    </form>


    <script>
        async function create() {
            const data = await fetch('http://localhost:12345/api/users', { //we did await becgase then is promise also
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    displayName: document.getElementById('displayName').value,
                    profilePic: document.getElementById('profilePic').value
                })
            });

            user = await data.json() //await - because of promise convert answer to json
            console.log(user)
        }

        async function get() {
            const userId = await document.getElementById('userIdInput').value;
            const url = `http://localhost:12345/api/users/${userId}`;
            const response = await fetch(url);
            const userData = await response.json();
            console.log(userData)
            return userData; // Return the fetched user data
        }


        async function update(fieldName) {
            const userId = document.getElementById('userIdInput').value;
            const fieldValue = document.getElementById(fieldName).value;

            const url = `http://localhost:12345/api/users/${userId}`;
            const response = await fetch(url, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ [fieldName]: fieldValue }) // Dynamically set the field to update
            });

            if (response.ok) {
                const updatedUser = await response.json();
                console.log(`${fieldName} updated successfully:`, updatedUser);
            } else {
                console.error("Failed to update", fieldName);
            }
        }


        async function del() {
            const userId = await document.getElementById('userIdInput').value;
            const url = `http://localhost:12345/api/users/${userId}`;
            const response = await fetch(url, {
                method: "DELETE",
            });

            if (response.ok) {
                const deletedUser = await response.json(); // Parse the response JSON
                console.log("User deleted successfully:", deletedUser); // Log the deleted article data
            } else {
                console.error("Failed to delete User");
            }
        }

        async function getUserFriends() {
            const userId = await document.getElementById('userIdInput').value;
            const url = `http://localhost:12345/api/users/${userId}/friends`;
            const response = await fetch(url);
            const data = await response.json();

            friendDisplayNames = []
            for (const friend of data.friends) {
                //console.log(friend)

                friendDisplayNames.push(friend.displayName);
            }

            console.log(friendDisplayNames); // Log the array of friend display names

            return friendDisplayNames;
        }


        async function addFriendRequest() {
            try {
                // need to put here the user that logged in as the sender !!!!!!!!!!!!
                // const senderId = hardcodedUserId; // for now, Eden always send friendRequests

                const recieverId = await document.getElementById('userIdInput').value; //the receiver

                const url = `http://localhost:12345/api/users/${recieverId}/friends`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log('Friend request sent successfully');
                    // Optionally, you can reload the friend list or perform any other action
                } else {
                    console.error('Failed to send friend request');
                }
            } catch (error) {
                console.error('Error adding friend request:', error);
            }
        }

        const hardcodedUserId = '65dca9a17c19003dd20aecd2'; // Eden's id

        async function acceptReq() {
            try {
            // need to put here   the user that logged in as the sender !!!!!!!!!!!!
                const senderId = hardcodedUserId; // for now, Eden always send friendRequests
                const recieverId = await document.getElementById('userIdInput').value; //the receiver

                const url = `http://localhost:12345/api/users/${recieverId}/friends/${senderId}`;
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    console.log('Friend request accept successfully');
                    // Optionally, you can reload the friend list or perform any other action
                } else {
                    console.error('Failed to accept  friend request');
                }
            } catch (error) {
                console.error('Error adding friend request:', error);
            }
        }

    </script>
</body>

</html>